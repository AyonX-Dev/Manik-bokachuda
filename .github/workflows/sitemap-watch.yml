name: Sitemap → Decode → GitHub + Telegram (final, robust & fixed)

on:
schedule:
- cron: '0 1 * * *'    # daily 01:00 UTC (change if needed)
workflow_dispatch:

jobs:
watch:
runs-on: ubuntu-latest
env:
SITEMAP_URL: "https://www.streamecho.top/sitemap.xml"
TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
PUSH_TOKEN: ${{ secrets.PUSH_TOKEN }}

steps:  
  - name: Checkout repo  
    uses: actions/checkout@v4  
    with:  
      fetch-depth: 0  

  - name: Install utilities & Python  
    run: |  
      sudo apt-get update -qq  
      sudo apt-get install -y jq  
      python -m pip install --upgrade pip  
    shell: bash  

  - name: Setup Python  
    uses: actions/setup-python@v4  
    with:  
      python-version: '3.11'  

  - name: Install python deps  
    run: |  
      pip install --upgrade requests beautifulsoup4  
    shell: bash  

  - name: Ensure tracker files exist  
    run: |  
      [ -f sitemap_urls.txt ] || echo "# sitemap urls collected by actions" > sitemap_urls.txt  
      [ -f found_playlists.txt ] || echo "# found playlist urls" > found_playlists.txt  
      [ -f chat_ids.txt ] || echo "# chat ids collected by actions" > chat_ids.txt  
      [ -f sent_log.txt ] || echo "# sent log: lines of chatid|postid" > sent_log.txt  
      git add sitemap_urls.txt found_playlists.txt chat_ids.txt sent_log.txt || true  
      git commit -m "chore: add tracker files (init)" || true  
    shell: bash  

  - name: Run sitemap processor (check latest 5)  
    run: |  
      echo "[*] Running process_sitemap.py"  
      python3 scripts/process_sitemap.py --sitemap "${SITEMAP_URL}" --tracked-file sitemap_urls.txt --playlists-file found_playlists.txt --out /tmp/new_posts.txt --max-check 5  
      echo "[*] new_posts (preview):"  
      [ -f /tmp/new_posts.txt ] && sed -n '1,200p' /tmp/new_posts.txt || echo "no /tmp/new_posts.txt"  
      echo "[*] decoded_results.json preview (if present):"  
      [ -f /tmp/decoded_results.json ] && jq -C . /tmp/decoded_results.json || echo "no /tmp/decoded_results.json"  
    shell: bash  

  - name: Commit decoded results (if any)  
    id: commit_decoded  
    run: |  
      if [ -s /tmp/new_posts.txt ]; then  
        cp /tmp/new_posts.txt decoded_results.txt  
        if [ -f /tmp/decoded_results.json ]; then cp /tmp/decoded_results.json decoded_results.json; fi  
        git add sitemap_urls.txt found_playlists.txt decoded_results.txt decoded_results.json || true  
        git config user.name "github-actions[bot]"  
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"  
        if git diff --staged --quiet; then  
          echo "no_changes=true" > /tmp/commit_decoded_result.txt  
        else  
          git commit -m "chore: add discovered playlist posts (auto)" || true  
          if [ -n "${PUSH_TOKEN:-}" ]; then  
            git remote set-url origin https://x-access-token:${PUSH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git  
            git push origin HEAD || true  
          else  
            git push origin HEAD || true  
          fi  
          echo "no_changes=false" > /tmp/commit_decoded_result.txt  
        fi  
      else  
        echo "no_new_posts" > /tmp/commit_decoded_result.txt  
      fi  
      cat /tmp/commit_decoded_result.txt  
    shell: bash  

  - name: Auto-capture chat IDs from getUpdates (delete webhook if set; collect ALL types)  
    run: |  
      set -euo pipefail  
      TOKEN="${TELEGRAM_BOT_TOKEN}"  
      CHATFILE="chat_ids.txt"  
      UFILE="/tmp/updates.json"  

      echo "[*] Checking webhook status..."  
      wh_info=$(curl -s "https://api.telegram.org/bot${TOKEN}/getWebhookInfo" || echo "{}")  
      wh_url=$(jq -r '.result.url // empty' <<<"$wh_info" 2>/dev/null || echo "")  

      if [ -n "$wh_url" ]; then  
        echo "[*] Webhook detected (url: $wh_url) — deleting webhook so getUpdates works."  
        curl -s -X POST "https://api.telegram.org/bot${TOKEN}/deleteWebhook" > /tmp/deletewh.json || true  
        cat /tmp/deletewh.json || true  
        sleep 1  
      else  
        echo "[*] No webhook set — proceeding to getUpdates."  
      fi  

      echo "[*] Fetching updates..."  
      curl -s "https://api.telegram.org/bot${TOKEN}/getUpdates" > ${UFILE} || true  

      echo "[*] Extracting IDs from updates..."  
      jq -r '  
        .result[]? |  
        (  
          .message.chat.id?,  
          .edited_message.chat.id?,  
          .channel_post.chat.id?,  
          .edited_channel_post.chat.id?,  
          .my_chat_member.chat.id?,  
          .chat_member.chat.id?,  
          .callback_query.message.chat.id?,  
          .callback_query.from.id?,  
          .inline_query.from.id?,  
          .pre_checkout_query.from.id?,  
          .shipping_query.from.id?,  
          .poll_answer.user.id?  
        )  
      ' ${UFILE} | grep -v null | sort -u | tr -d '\r' > /tmp/all_ids.txt || true  

      echo "[*] IDs found:"  
      sed -n '1,200p' /tmp/all_ids.txt || true  

      # Append any new ids to chat_ids.txt (keep existing order)  
      while IFS= read -r id; do  
        [ -z "$id" ] && continue  
        # trim whitespace / CR  
        id="$(echo "$id" | tr -d '\r' | xargs)"  
        if [ -z "$id" ]; then continue; fi  
        if grep -Fqx -- "$id" "$CHATFILE"; then  
          echo "exists: $id"  
        else  
          echo "$id" >> "$CHATFILE"  
          echo "added new chat id: $id"  
        fi  
      done < /tmp/all_ids.txt  

      # Deduplicate & keep first occurrence  
      awk '!seen[$0]++' "$CHATFILE" > /tmp/chat_ids.tmp && mv /tmp/chat_ids.tmp "$CHATFILE"  

      git add "$CHATFILE" || true  
      if ! git diff --staged --quiet; then  
        git config user.name "github-actions[bot]"  
        git config user.email "github-actions[bot]@users.noreply.github.com"  
        git commit -m "chore: update chat_ids (auto)" || true  
        if [ -n "${PUSH_TOKEN:-}" ]; then  
          git remote set-url origin https://x-access-token:${PUSH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git  
          git push origin HEAD || true  
        else  
          git push origin HEAD || true  
        fi  
      else  
        echo "chat ids unchanged"  
      fi  
    shell: bash  

  - name: Broadcast decoded posts to all chat IDs (send-to-all, retries, flock-safe)  
    run: |  
      set -euo pipefail  
      TOKEN="${TELEGRAM_BOT_TOKEN}"  
      CHATFILE="chat_ids.txt"  
      JSON="/tmp/decoded_results.json"  
      SENTLOG="sent_log.txt"  
      LOCK="/tmp/sent_log.lock"  

      is_valid_url() { printf '%s' "$1" | grep -E -q '^https?://'; }  

      if [ ! -s "${JSON}" ]; then  
        echo "[*] No JSON results to broadcast; exiting."  
        exit 0  
      fi  

      # load chat ids (ignore comments/blank)  
      mapfile -t ALL_CIDS < <(grep -vE '^\s*#|^\s*$' "${CHATFILE}" || true)  
      # sanitize each id (remove CR and trim)  
      for i in "${!ALL_CIDS[@]}"; do  
        ALL_CIDS[$i]=$(echo "${ALL_CIDS[$i]}" | tr -d '\r' | xargs)  
      done  

      echo "[*] total chat ids to attempt:" "${#ALL_CIDS[@]}"  

      # iterate posts  
      jq -c '.[]' "${JSON}" | while read -r item; do  
        title=$(jq -r '.title // ""'   <<<"$item")  
        thumb=$(jq -r '.thumbnail // ""'<<<"$item")  
        link=$(jq -r '.playlist // ""'  <<<"$item")  
        postid="${link}"  
        CAPTION=$(printf "%s\n%s" "$title" "$link")  

        for cid in "${ALL_CIDS[@]}"; do  
          # skip empty/comment lines  
          if [[ -z "${cid}" || "${cid}" =~ ^\# ]]; then  
            continue  
          fi  

          echo "[*] Attempt send to: ${cid} (post: ${postid})"  

          attempts=0  
          max_attempts=3  
          success=false  

          while [ $attempts -lt $max_attempts ]; do  
            attempts=$((attempts+1))  

            (  
              flock -x 200  

              # if already logged as sent, skip (use -- to stop grep treating leading '-' as option)  
              if grep -Fqx -- "${cid}|${postid}" "${SENTLOG}"; then  
                echo "Already logged as sent, skipping: ${cid} -> ${postid}"  
                exit 0  
              fi  

              # perform send (photo if thumb valid)  
              if [ -n "$thumb" ] && is_valid_url "$thumb"; then  
                resp=$(curl -s -m 30 -X POST "https://api.telegram.org/bot${TOKEN}/sendPhoto" \  
                  -d chat_id="${cid}" \  
                  --data-urlencode "photo=${thumb}" \  
                  --data-urlencode "caption=${CAPTION}")  
              else  
                resp=$(curl -s -m 30 -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \  
                  -d chat_id="${cid}" \  
                  --data-urlencode "text=${CAPTION}")  
              fi  

              # save response for debugging  
              echo "${resp}" > /tmp/last_send_resp_${cid}.json || true  
              ok=$(jq -r '.ok // false' /tmp/last_send_resp_${cid}.json 2>/dev/null || echo "false")  
              desc=$(jq -r '.description // ""' /tmp/last_send_resp_${cid}.json 2>/dev/null || echo "")  
              errcode=$(jq -r '.error_code // 0' /tmp/last_send_resp_${cid}.json 2>/dev/null || echo "0")  

              if [ "$ok" = "true" ] || [ "$ok" = "True" ]; then  
                echo "${cid}|${postid}" >> "${SENTLOG}"  
                success=true  
                echo "[+] Send OK -> ${cid} (post: ${postid})"  
                exit 0  
              else  
                echo "[-] Send FAILED -> ${cid} (post: ${postid}) ; reason: ${desc} ; code: ${errcode}"  
                if [ "${errcode}" = "429" ] || ( [ "${errcode}" -ge 500 ] 2>/dev/null ); then  
                  echo "[~] Transient error, will retry (attempt ${attempts}/${max_attempts})"  
                  exit 1  
                else  
                  # permanent error — do not retry  
                  exit 2  
                fi  
              fi  

            ) 200>"${LOCK}"  

            rc=$?  
            if [ $rc -eq 0 ]; then  
              success=true  
              break  
            elif [ $rc -eq 1 ]; then  
              sleep $((attempts * 2))  
              continue  
            else  
              break  
            fi  
          done  

          if [ "$success" != "true" ]; then  
            echo "Final: failed to send to ${cid} after ${attempts} attempts. See /tmp/last_send_resp_${cid}.json"  
          fi  

          sleep 0.6  
        done  
      done  

      # commit sent_log updates (if any)  
      git add "${SENTLOG}" || true  
      if git diff --staged --quiet; then  
        echo "[*] no new sent_log entries"  
      else  
        git config user.name "github-actions[bot]"  
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"  
        git commit -m "chore: update sent_log (auto)" || true  
        if [ -n "${PUSH_TOKEN:-}" ]; then  
          git remote set-url origin https://x-access-token:${PUSH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git  
          git push origin HEAD || true  
        else  
          git push origin HEAD || true  
        fi  
      fi  
    shell: bash  

  - name: Final status  
    run: |  
      echo "Workflow finished."  
    shell: bash
