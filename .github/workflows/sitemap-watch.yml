name: Sitemap → Decode → GitHub + Telegram (compatible)

on:
  schedule:
    - cron: '0 1 * * *'    # daily 01:00 UTC
  workflow_dispatch:

jobs:
  watch:
    runs-on: ubuntu-latest
    env:
      SITEMAP_URL: "https://www.streamecho.top/sitemap.xml"
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      PUSH_TOKEN: ${{ secrets.PUSH_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y jq
          python -m pip install --upgrade pip
          pip install --upgrade requests beautifulsoup4
        shell: bash

      - name: Ensure tracker files exist
        run: |
          [ -f sitemap_urls.txt ] || echo "# sitemap urls collected by actions" > sitemap_urls.txt
          [ -f found_playlists.txt ] || echo "# found playlist urls" > found_playlists.txt
          [ -f chat_ids.txt ] || echo "# chat ids collected by actions" > chat_ids.txt
          [ -f sent_log.txt ] || echo "# sent log: lines of chatid|postid" > sent_log.txt
          [ -f blocked_chats.txt ] || echo "# blocked chat ids (forbidden/kicked)" > blocked_chats.txt
          git add sitemap_urls.txt found_playlists.txt chat_ids.txt sent_log.txt blocked_chats.txt || true
          git commit -m "chore: add tracker files (init)" || true
        shell: bash

      - name: Run sitemap processor (latest 5)
        run: |
          echo "[*] Running process_sitemap.py"
          python3 scripts/process_sitemap.py --sitemap "${SITEMAP_URL}" --tracked-file sitemap_urls.txt --playlists-file found_playlists.txt --out /tmp/new_posts.txt --max-check 5
          echo "[*] Preview /tmp/new_posts.txt:"
          if [ -f /tmp/new_posts.txt ]; then sed -n '1,200p' /tmp/new_posts.txt; fi
          if [ -f /tmp/decoded_results.json ]; then jq -C . /tmp/decoded_results.json || true; fi
        shell: bash

      - name: Commit decoded results (if any)
        run: |
          if [ -s /tmp/new_posts.txt ]; then
            cp /tmp/new_posts.txt decoded_results.txt
            if [ -f /tmp/decoded_results.json ]; then cp /tmp/decoded_results.json decoded_results.json; fi
            git add sitemap_urls.txt found_playlists.txt decoded_results.txt decoded_results.json || true
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            if ! git diff --staged --quiet; then
              git commit -m "chore: add discovered playlist posts (auto)" || true
              if [ -n "${PUSH_TOKEN:-}" ]; then
                git remote set-url origin https://x-access-token:${PUSH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
                git push origin HEAD || true
              else
                git push origin HEAD || true
              fi
            fi
          else
            echo "No new posts to commit."
          fi
        shell: bash

      - name: Auto-capture chat IDs (getUpdates; safe)
        run: |
          set -euo pipefail
          TOKEN="${TELEGRAM_BOT_TOKEN}"
          CHATFILE="chat_ids.txt"
          UFILE="/tmp/updates.json"
          ALLIDS="/tmp/all_ids.txt"

          echo "[*] check webhook"
          wh_info=$(curl -s "https://api.telegram.org/bot${TOKEN}/getWebhookInfo" || echo "{}")
          wh_url=$(jq -r '.result.url // empty' <<<"$wh_info" 2>/dev/null || echo "")

          if [ -n "$wh_url" ]; then
            echo "[*] webhook exists -> deleting"
            curl -s -X POST "https://api.telegram.org/bot${TOKEN}/deleteWebhook" > /tmp/deletewh.json || true
            sleep 1
          fi

          echo "[*] getUpdates..."
          curl -s "https://api.telegram.org/bot${TOKEN}/getUpdates" > "${UFILE}" || true

          # extract many update shapes to /tmp/all_ids.txt (unique)
          jq -r '
            .result[]? |
            (
              .message.chat.id?,
              .edited_message.chat.id?,
              .channel_post.chat.id?,
              .edited_channel_post.chat.id?,
              .my_chat_member.chat.id?,
              .chat_member.chat.id?,
              .callback_query.message.chat.id?,
              .callback_query.from.id?,
              .inline_query.from.id?,
              .pre_checkout_query.from.id?,
              .shipping_query.from.id?,
              .poll_answer.user.id?
            )
          ' "${UFILE}" | grep -v null | sort -u | tr -d "\r" > "${ALLIDS}" || true

          echo "[*] found ids:"
          cat "${ALLIDS}" || true

          while IFS= read -r id; do
            [ -z "$id" ] && continue
            id="$(echo "$id" | xargs)"  # trim
            if [ -z "$id" ]; then continue; fi
            if grep -Fqx -- "$id" "$CHATFILE"; then
              echo "exists: $id"
            else
              echo "$id" >> "$CHATFILE"
              echo "added: $id"
            fi
          done < "${ALLIDS}"

          # dedupe keeping first occurrence
          awk '!seen[$0]++' "$CHATFILE" > /tmp/chat_ids.tmp && mv /tmp/chat_ids.tmp "$CHATFILE"

          git add "$CHATFILE" || true
          if ! git diff --staged --quiet; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit -m "chore: update chat_ids (auto)" || true
            if [ -n "${PUSH_TOKEN:-}" ]; then
              git remote set-url origin https://x-access-token:${PUSH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
              git push origin HEAD || true
            else
              git push origin HEAD || true
            fi
          else
            echo "chat ids unchanged"
          fi
        shell: bash

      - name: Broadcast (simple, lock via mkdir, handle blocked)
        run: |
          set -euo pipefail
          TOKEN="${TELEGRAM_BOT_TOKEN}"
          CHATFILE="chat_ids.txt"
          BLOCKFILE="blocked_chats.txt"
          JSON="/tmp/decoded_results.json"
          SENTLOG="sent_log.txt"
          LOCKDIR="/tmp/sent_log.lockdir"

          [ -f "${BLOCKFILE}" ] || echo "# blocked chat ids" > "${BLOCKFILE}"

          if [ ! -s "${JSON}" ]; then
            echo "[*] No decoded results; nothing to broadcast."
            exit 0
          fi

          # read chat ids into array (simple)
          echo "[*] Loading chat ids..."
          IDS_TMP="/tmp/ids_to_use.txt"
          grep -vE '^\s*#|^\s*$' "${CHATFILE}" | tr -d '\r' > "${IDS_TMP}" || true
          echo "[*] total chat ids:" $(wc -l < "${IDS_TMP}" || echo 0)

          # For each discovered post object
          jq -c '.[]' "${JSON}" | while read -r item; do
            title=$(jq -r '.title // ""' <<<"$item")
            thumb=$(jq -r '.thumbnail // ""' <<<"$item")
            link=$(jq -r '.playlist // ""' <<<"$item")
            postid="${link}"
            caption="$(printf "%s\n%s" "$title" "$link")"

            while IFS= read -r cid; do
              cid="$(echo "$cid" | xargs)"
              [ -z "$cid" ] && continue

              # skip blocked
              if grep -Fxq "$cid" "${BLOCKFILE}"; then
                echo "[!] skipping blocked: $cid"
                continue
              fi

              # skip already sent
              if grep -Fqx -- "${cid}|${postid}" "${SENTLOG}"; then
                echo "[*] already sent to ${cid}, skipping"
                continue
              fi

              echo "[*] sending to ${cid} ..."

              attempts=0
              max_attempts=2
              delivered=false

              while [ $attempts -lt $max_attempts ]; do
                attempts=$((attempts+1))

                # send (photo if exists and is http)
                if [ -n "$thumb" ] && printf "%s" "$thumb" | grep -E -q '^https?://'; then
                  resp=$(curl -s -m 25 -X POST "https://api.telegram.org/bot${TOKEN}/sendPhoto" -d chat_id="${cid}" --data-urlencode "photo=${thumb}" --data-urlencode "caption=${caption}" ) || true
                else
                  resp=$(curl -s -m 25 -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" -d chat_id="${cid}" --data-urlencode "text=${caption}" ) || true
                fi

                # save resp
                echo "${resp}" > /tmp/last_send_resp_${cid}.json || true
                ok=$(jq -r '.ok // false' /tmp/last_send_resp_${cid}.json 2>/dev/null || echo "false")
                errcode=$(jq -r '.error_code // 0' /tmp/last_send_resp_${cid}.json 2>/dev/null || echo "0")
                desc=$(jq -r '.description // ""' /tmp/last_send_resp_${cid}.json 2>/dev/null || echo "")

                if [ "$ok" = "true" ]; then
                  # acquire lock (mkdir atomic)
                  t=0
                  while ! mkdir "${LOCKDIR}" 2>/dev/null; do
                    t=$((t+1))
                    if [ $t -gt 20 ]; then break; fi
                    sleep 0.1
                  done
                  echo "${cid}|${postid}" >> "${SENTLOG}"
                  rmdir "${LOCKDIR}" 2>/dev/null || true
                  echo "[+] send OK -> ${cid}"
                  delivered=true
                  break
                fi

                # not ok -> check code
                if [ "${errcode}" = "429" ] || ( [ "${errcode}" -ge 500 ] 2>/dev/null ); then
                  echo "[~] transient (${errcode}) -> attempt ${attempts}/${max_attempts}"
                  sleep $((attempts * 2))
                  continue
                else
                  # permanent -> block and stop retrying
                  echo "[-] permanent failure for ${cid}: ${desc} (code ${errcode})"
                  if ! grep -Fxq "$cid" "${BLOCKFILE}"; then
                    echo "$cid" >> "${BLOCKFILE}"
                    echo "[!] added ${cid} to blocked_chats"
                  fi
                  break
                fi
              done

              if [ "$delivered" != "true" ]; then
                echo "[*] not delivered to ${cid} after ${attempts} attempts."
              fi

              # light throttle
              sleep 0.6

            done < "${IDS_TMP}"

          done

          # commit logs if changed
          git add "${SENTLOG}" "${BLOCKFILE}" || true
          if ! git diff --staged --quiet; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git commit -m "chore: update sent_log/blocked_chats (auto)" || true
            if [ -n "${PUSH_TOKEN:-}" ]; then
              git remote set-url origin https://x-access-token:${PUSH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
              git push origin HEAD || true
            else
              git push origin HEAD || true
            fi
          fi
        shell: bash

      - name: Final status
        run: |
          echo "done"
        shell: bash
