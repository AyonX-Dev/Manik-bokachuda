name: Sitemap → Decode → GitHub + Telegram (send-to-all, retries, flock-safe)

on:
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:

jobs:
  watch:
    runs-on: ubuntu-latest
    env:
      SITEMAP_URL: "https://www.streamecho.top/sitemap.xml"
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      PUSH_TOKEN: ${{ secrets.PUSH_TOKEN }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install utilities & Python
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y jq
          python -m pip install --upgrade pip
        shell: bash

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install python deps
        run: |
          pip install requests beautifulsoup4
        shell: bash

      - name: Ensure tracker files exist
        run: |
          [ -f sitemap_urls.txt ] || echo "# sitemap urls collected by actions" > sitemap_urls.txt
          [ -f found_playlists.txt ] || echo "# found playlist urls" > found_playlists.txt
          [ -f chat_ids.txt ] || echo "# chat ids collected by actions" > chat_ids.txt
          [ -f sent_log.txt ] || echo "# sent log: lines of chatid|postid" > sent_log.txt
          git add sitemap_urls.txt found_playlists.txt chat_ids.txt sent_log.txt || true
          git commit -m "chore: add tracker files (init)" || true
        shell: bash

      - name: Run processor (check latest 5)
        run: |
          python3 scripts/process_sitemap.py --sitemap "${SITEMAP_URL}" --tracked-file sitemap_urls.txt --playlists-file found_playlists.txt --out /tmp/new_posts.txt --max-check 5
          ls -l /tmp/new_posts.txt || true
          sed -n '1,200p' /tmp/new_posts.txt || true
          ls -l /tmp/decoded_results.json || true
          jq -C . /tmp/decoded_results.json 2>/dev/null || true
        shell: bash

      - name: Commit decoded results (if any)
        id: commit_decoded
        run: |
          if [ -s /tmp/new_posts.txt ]; then
            cp /tmp/new_posts.txt decoded_results.txt
            cp /tmp/decoded_results.json decoded_results.json || true
            git add sitemap_urls.txt found_playlists.txt decoded_results.txt decoded_results.json || true
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            if git diff --staged --quiet; then
              echo "no_changes=true" > /tmp/commit_decoded_result.txt
            else
              git commit -m "chore: add discovered playlist posts (auto)"
              if [ -n "${PUSH_TOKEN}" ]; then
                git remote set-url origin https://x-access-token:${PUSH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
                git push origin HEAD || true
              else
                git push origin HEAD || true
              fi
              echo "no_changes=false" > /tmp/commit_decoded_result.txt
            fi
          else
            echo "no_new_posts" > /tmp/commit_decoded_result.txt
          fi
          cat /tmp/commit_decoded_result.txt
        shell: bash

      - name: Auto-capture chat IDs from getUpdates (no duplicates + dedupe)
        run: |
          set -e
          TOKEN="${TELEGRAM_BOT_TOKEN}"
          UFILE="/tmp/updates.json"
          CHATFILE="chat_ids.txt"

          curl -s "https://api.telegram.org/bot${TOKEN}/getUpdates" > ${UFILE} || true
          jq -r '.. | .chat? | .id? // empty' ${UFILE} | sort -u > /tmp/ids_found.txt || true

          while IFS= read -r id; do
            [ -z "$id" ] && continue
            if grep -Fqx "$id" "${CHATFILE}"; then
              echo "exists: $id"
            else
              echo "$id" >> "${CHATFILE}"
              echo "added new chat id: $id"
            fi
          done < /tmp/ids_found.txt

          # dedupe chat_ids.txt (keep first occurrence)
          awk '!seen[$0]++' "${CHATFILE}" > /tmp/chat_ids.tmp && mv /tmp/chat_ids.tmp "${CHATFILE}"

          git add "${CHATFILE}" || true
          if git diff --staged --quiet; then
            echo "chat ids unchanged"
          else
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git commit -m "chore: update chat_ids (auto)" || true
            if [ -n "${PUSH_TOKEN}" ]; then
              git remote set-url origin https://x-access-token:${PUSH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
              git push origin HEAD || true
            else
              git push origin HEAD || true
            fi
          fi
        shell: bash

      - name: Broadcast decoded posts to all chat IDs (send-to-all, retries, flock-safe)
        run: |
          set -e
          TOKEN="${TELEGRAM_BOT_TOKEN}"
          CHATFILE="chat_ids.txt"
          JSON="/tmp/decoded_results.json"
          SENTLOG="sent_log.txt"
          LOCK="/tmp/sent_log.lock"

          is_valid_url() { printf '%s' "$1" | grep -E -q '^https?://'; }

          if [ ! -s "${JSON}" ]; then
            echo "No JSON results to broadcast."
            exit 0
          fi

          # read all chat ids into an array to avoid race on file during loop
          mapfile -t ALL_CIDS < <(grep -vE '^\s*#|^\s*$' "${CHATFILE}" || true)

          # iterate posts
          jq -c '.[]' "${JSON}" | while read -r item; do
            title=$(jq -r '.title // ""'   <<<"$item")
            thumb=$(jq -r '.thumbnail // ""'<<<"$item")
            link=$(jq -r '.playlist // ""'  <<<"$item")
            postid="${link}"
            CAPTION=$(printf "%s\n%s" "$title" "$link")

            # for each chat id attempt send (with retries). ensure we attempt all cids.
            for cid in "${ALL_CIDS[@]}"; do
              # skip empty/comment lines
              if [[ -z "${cid}" || "${cid}" =~ ^\# ]]; then
                continue
              fi

              echo "=> Attempting send to: ${cid} (post: ${postid})"

              # attempt send with retry logic; do not exit the outer loop on failure
              attempts=0
              max_attempts=3
              success=false

              while [ $attempts -lt $max_attempts ]; do
                attempts=$((attempts+1))

                # atomic section for check+send+log to avoid race conditions
                (
                  flock -x 200

                  # if already logged as sent, skip
                  if grep -Fqx "${cid}|${postid}" "${SENTLOG}"; then
                    echo "Already logged as sent, skipping: ${cid} -> ${postid}"
                    # mark as success so we don't retry
                    exit 0
                  fi

                  # perform send
                  if [ -n "$thumb" ] && is_valid_url "$thumb"; then
                    resp=$(curl -s -m 30 -X POST "https://api.telegram.org/bot${TOKEN}/sendPhoto" \
                      -d chat_id="${cid}" \
                      --data-urlencode "photo=${thumb}" \
                      --data-urlencode "caption=${CAPTION}")
                  else
                    resp=$(curl -s -m 30 -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
                      -d chat_id="${cid}" \
                      --data-urlencode "text=${CAPTION}")
                  fi

                  # save response for debugging
                  echo "${resp}" > /tmp/last_send_resp_${cid}.json || true
                  ok=$(jq -r '.ok // false' /tmp/last_send_resp_${cid}.json 2>/dev/null || echo "false")
                  desc=$(jq -r '.description // ""' /tmp/last_send_resp_${cid}.json 2>/dev/null || echo "")
                  errcode=$(jq -r '.error_code // 0' /tmp/last_send_resp_${cid}.json 2>/dev/null || echo "0")

                  if [ "$ok" = "true" ] || [ "$ok" = "True" ]; then
                    # log success and mark
                    echo "${cid}|${postid}" >> "${SENTLOG}"
                    success=true
                    echo "Send OK -> ${cid} (post: ${postid})"
                    exit 0
                  else
                    # on non-ok, emit reason (but do not log)
                    echo "Send FAILED -> ${cid} (post: ${postid}) ; reason: ${desc} ; code: ${errcode}"
                    # decide whether to retry based on error code
                    # retry on rate-limit (429) or 5xx server errors (>=500)
                    if [ "${errcode}" = "429" ] || ( [ "${errcode}" -ge 500 ] 2>/dev/null ); then
                      echo "Transient error, will retry (attempt ${attempts}/${max_attempts})"
                      # release flock and allow retry after sleep
                      exit 1
                    else
                      # permanent error, do not retry
                      exit 2
                    fi
                  fi

                ) 200>"${LOCK}"
                rc=$?
                if [ $rc -eq 0 ]; then
                  success=true
                  break
                elif [ $rc -eq 1 ]; then
                  # transient error: backoff then retry
                  sleep $((attempts * 2))
                  continue
                else
                  # permanent error, break retries
                  break
                fi
              done

              if [ "$success" != "true" ]; then
                echo "Final: failed to send to ${cid} after ${attempts} attempts. See /tmp/last_send_resp_${cid}.json"
              fi

              # short pause to avoid hitting Telegram limits
              sleep 0.6
            done

          done

          # commit sent_log updates (if any)
          git add "${SENTLOG}" || true
          if git diff --staged --quiet; then
            echo "no new sent_log entries"
          else
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git commit -m "chore: update sent_log (auto)" || true
            if [ -n "${PUSH_TOKEN}" ]; then
              git remote set-url origin https://x-access-token:${PUSH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
              git push origin HEAD || true
            else
              git push origin HEAD || true
            fi
          fi
        shell: bash

      - name: Final status
        run: |
          echo "Workflow finished."
        shell: bash
