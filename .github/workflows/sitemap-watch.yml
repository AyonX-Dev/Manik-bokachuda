name: Sitemap → Decode → GitHub + Telegram (auto-capture getUpdates URL supported)

on:
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:

env:
  SITEMAP_URL: "https://www.streamecho.top/sitemap.xml"
  # Optionally provide a full getUpdates URL here (for testing/demo).
  # If not provided, the workflow will use TELEGRAM_BOT_TOKEN to build the API URL.
  # Example test URL: https://api.telegram.org/bot849240:AAHkKk-mMaO_TLkF07fi1E3E/getUpdates
  TELEGRAM_GETUPDATES_URL: ${{ secrets.TELEGRAM_GETUPDATES_URL }}

jobs:
  watch:
    runs-on: ubuntu-latest
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      PUSH_TOKEN: ${{ secrets.PUSH_TOKEN }}
      SITEMAP_URL: ${{ env.SITEMAP_URL }}
      TELEGRAM_GETUPDATES_URL: ${{ env.TELEGRAM_GETUPDATES_URL }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare environment
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y jq
          python -m pip install --upgrade pip
        shell: bash

      - name: Ensure tracker files exist
        run: |
          [ -f sitemap_urls.txt ] || echo "# sitemap urls collected by actions" > sitemap_urls.txt
          [ -f found_playlists.txt ] || echo "# found playlist urls" > found_playlists.txt
          [ -f chat_ids.txt ] || echo "# chat ids collected by actions" > chat_ids.txt
          [ -f sent_log.txt ] || echo "# sent log: lines of chatid|postid" > sent_log.txt
          git add sitemap_urls.txt found_playlists.txt chat_ids.txt sent_log.txt || true
          git commit -m "chore: add tracker files (init)" || true
        shell: bash

      - name: Run sitemap processor (assumes scripts/process_sitemap.py exists)
        run: |
          python3 scripts/process_sitemap.py --sitemap "${SITEMAP_URL}" --tracked-file sitemap_urls.txt --playlists-file found_playlists.txt --out /tmp/new_posts.txt --max-check 5
          ls -l /tmp/new_posts.txt || true
          ls -l /tmp/decoded_results.json || true
        shell: bash

      - name: Commit decoded results (if any)
        run: |
          if [ -s /tmp/new_posts.txt ]; then
            cp /tmp/new_posts.txt decoded_results.txt
            cp /tmp/decoded_results.json decoded_results.json || true
            git add sitemap_urls.txt found_playlists.txt decoded_results.txt decoded_results.json || true
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            if git diff --staged --quiet; then
              echo "no_changes=true"
            else
              git commit -m "chore: add discovered playlist posts (auto)" || true
              if [ -n "${PUSH_TOKEN}" ]; then
                git remote set-url origin https://x-access-token:${PUSH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
                git push origin HEAD || true
              else
                git push origin HEAD || true
              fi
            fi
          else
            echo "no_new_posts"
          fi
        shell: bash

      - name: Auto-capture chat IDs from getUpdates (use provided URL if set)
        id: capture_chats
        run: |
          set -euo pipefail

          CHATFILE="chat_ids.txt"
          UFILE="/tmp/updates.json"

          # decide which getUpdates URL to use:
          if [ -n "${TELEGRAM_GETUPDATES_URL:-}" ]; then
            GETUP_URL="${TELEGRAM_GETUPDATES_URL}"
            echo "Using provided TELEGRAM_GETUPDATES_URL"
          elif [ -n "${TELEGRAM_BOT_TOKEN:-}" ]; then
            GETUP_URL="https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getUpdates"
            echo "Using built getUpdates URL from TELEGRAM_BOT_TOKEN"
          else
            echo "No getUpdates URL or TELEGRAM_BOT_TOKEN available -- skipping auto-capture"
            exit 0
          fi

          echo "Fetching updates from: ${GETUP_URL}"
          curl -s "${GETUP_URL}" -o "${UFILE}" || true
          # Extract all relevant chat ids from common update fields
          jq -r '
            .result[]? |
            (
              .message.chat.id?,
              .edited_message.chat.id?,
              .channel_post.chat.id?,
              .edited_channel_post.chat.id?,
              .my_chat_member.chat.id?,
              .chat_member.chat.id?
            )
          ' "${UFILE}" | grep -v null | sort -u > /tmp/all_ids.txt || true

          echo "Found ids:"
          cat /tmp/all_ids.txt || true

          # Append any new ids (exact match) to chat_ids.txt
          while IFS= read -r id; do
            [ -z "$id" ] && continue
            if grep -Fqx "$id" "${CHATFILE}"; then
              echo "exists: $id"
            else
              echo "$id" >> "${CHATFILE}"
              echo "added new chat id: $id"
            fi
          done < /tmp/all_ids.txt

          # Dedupe chat_ids.txt (keep first occurrence)
          awk '!seen[$0]++' "${CHATFILE}" > /tmp/chat_ids.tmp && mv /tmp/chat_ids.tmp "${CHATFILE}"

          # Commit updated chat_ids.txt if changed
          git add "${CHATFILE}" || true
          if git diff --staged --quiet; then
            echo "chat ids unchanged"
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit -m "chore: update chat_ids (auto)" || true
            if [ -n "${PUSH_TOKEN:-}" ]; then
              git remote set-url origin https://x-access-token:${PUSH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
              git push origin HEAD || true
            else
              git push origin HEAD || true
            fi
          fi
        shell: bash

      - name: Broadcast decoded posts to all chat IDs (simple attempt; respects sent_log)
        run: |
          set -e
          TOKEN="${TELEGRAM_BOT_TOKEN:-}"
          CHATFILE="chat_ids.txt"
          JSON="/tmp/decoded_results.json"
          SENTLOG="sent_log.txt"
          LOCK="/tmp/sent_log.lock"

          # If no JSON, nothing to broadcast
          if [ ! -s "${JSON}" ]; then
            echo "No decoded_results.json, nothing to broadcast."
            exit 0
          fi

          # prepare list of chat ids (ignore commented/blank)
          mapfile -t ALL_CIDS < <(grep -vE '^\s*#|^\s*$' "${CHATFILE}" || true)

          jq -c '.[]' "${JSON}" | while read -r item; do
            title=$(jq -r '.title // ""' <<<"$item")
            thumb=$(jq -r '.thumbnail // ""' <<<"$item")
            link=$(jq -r '.playlist // ""' <<<"$item")
            postid="${link}"
            CAPTION=$(printf "%s\n%s" "$title" "$link")

            for cid in "${ALL_CIDS[@]}"; do
              if [[ -z "${cid}" || "${cid}" =~ ^\# ]]; then continue; fi

              echo "Attempt send to ${cid} -> ${postid}"

              (
                flock -x 200

                # skip if already logged
                if grep -Fqx "${cid}|${postid}" "${SENTLOG}"; then
                  echo "Already sent: ${cid}|${postid}"
                  exit 0
                fi

                # choose send method (photo or message)
                if [ -n "$thumb" ] && printf '%s' "$thumb" | grep -qE '^https?://'; then
                  resp=$(curl -s -m 30 -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendPhoto" \
                    -d chat_id="${cid}" \
                    --data-urlencode "photo=${thumb}" \
                    --data-urlencode "caption=${CAPTION}")
                else
                  resp=$(curl -s -m 30 -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                    -d chat_id="${cid}" \
                    --data-urlencode "text=${CAPTION}")
                fi

                # Save and check response; log only on success
                echo "${resp}" > /tmp/last_send_resp_${cid}.json || true
                ok=$(jq -r '.ok // false' /tmp/last_send_resp_${cid}.json 2>/dev/null || echo "false")
                if [ "$ok" = "true" ]; then
                  echo "${cid}|${postid}" >> "${SENTLOG}"
                  echo "Sent OK -> ${cid}"
                else
                  desc=$(jq -r '.description // ""' /tmp/last_send_resp_${cid}.json 2>/dev/null || echo "")
                  echo "Send failed to ${cid} : ${desc}"
                fi

              ) 200>"${LOCK}"

              sleep 0.6
            done
          done
        shell: bash

      - name: Commit sent_log updates (if any)
        run: |
          git add sent_log.txt || true
          if git diff --staged --quiet; then
            echo "no new sent_log entries"
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit -m "chore: update sent_log (auto)" || true
            if [ -n "${PUSH_TOKEN:-}" ]; then
              git remote set-url origin https://x-access-token:${PUSH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
              git push origin HEAD || true
            else
              git push origin HEAD || true
            fi
          fi
        shell: bash

      - name: Done
        run: echo "Workflow finished."
        shell: bash
